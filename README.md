# Chess Repertoire Generator

Generate chess opening repertoires using Lichess statistics with configurable parameters for move scoring and branch termination.

## Features

- **Data Source**: Lichess opening explorer API
- **Move Scoring**: Combines expected score (win rate) and popularity with configurable weights
- **Smart Termination**: Branches terminate based on insufficient games, white advantage, or depth limits
- **Caching**: Persistent JSON cache to avoid redundant API calls
- **Multiple Outputs**: PGN format and human-readable text tree
- **Configurable**: All parameters adjustable via CLI

## Directory Structure

```
/repertoire/
├── data/                   # Cache and data files
│   └── cache.json         # Lichess API cache
├── output/                # Generated repertoire files
│   └── *.pgn             # PGN format repertoires
├── *.py                  # Source code files
├── pyproject.toml        # Project configuration
└── README.md            # Documentation
```

## Installation

```bash
# Install dependencies with uv
uv sync
```

## Usage

### Basic Usage

```bash
# Generate repertoire PGN file
uv run python repertoire_builder.py --opening "d4" --output-pgn output/repertoire.pgn
```

### Advanced Usage

```bash
uv run python repertoire_builder.py \
  --opening "e4" \
  --depth 6 \
  --min-rating 2000 \
  --time-controls "classical,rapid" \
  --win-rate-weight 0.8 \
  --popularity-weight 0.2 \
  --initial-threshold 0.05 \
  --position-threshold 0.10 \
  --min-games 500 \
  --advantage-threshold 0.40 \
  --output-pgn output/e4_repertoire.pgn \
  --cache-file data/e4_cache.json \
  --api-key your_lichess_api_key
```

## Parameters

| Parameter | Default | Description |
|-----------|---------|-------------|
| `--opening` | `Nf3` | Opening move in SAN notation |
| `--depth` | `5` | Maximum depth in moves |
| `--min-rating` | `1600` | Minimum player rating for games |
| `--time-controls` | `blitz,rapid` | Comma-separated time controls |
| `--win-rate-weight` | `0.7` | Weight for expected score in move scoring |
| `--popularity-weight` | `0.3` | Weight for popularity in move scoring |
| `--initial-threshold` | `0.10` | Minimum play rate for initial position responses |
| `--position-threshold` | `0.15` | Minimum play rate for subsequent positions |
| `--min-games` | `200` | Minimum games required to continue branch |
| `--advantage-threshold` | `0.42` | White advantage threshold (terminates if no Black move scores higher) |
| `--output-pgn` | - | Output PGN file path |
| `--cache-file` | `data/cache.json` | Cache file path |
| `--api-key` | - | Lichess API key for authenticated requests (removes rate limits) |
| `--api-delay` | `0.01` | Delay between API requests in seconds (ignored if using API key) |

## API Authentication

To avoid rate limiting, you can use a Lichess API key in several ways:

### Method 1: .env File (Recommended)
1. Go to https://lichess.org/account/oauth/token
2. Create a new personal access token
3. Create a `.env` file in the project root:
   ```
   LICHESS_API_KEY=lip_your_token_here
   ```
4. Run commands normally (API key will be loaded automatically)

### Method 2: Command Line
```bash
python repertoire_builder.py --opening e4 --api-key lip_your_token_here
```

### Method 3: Environment Variable
```bash
export LICHESS_API_KEY=lip_your_token_here
python repertoire_builder.py --opening e4
```

**Priority:** Command line > Environment variable > .env file

With an API key, requests are not rate-limited and the `--api-delay` parameter is ignored.

## Move Scoring

Moves are scored using the formula:
```
Move Score = (Expected Score × win_weight) + (Popularity × pop_weight)
```

Where:
- **Expected Score** = (Wins + 0.5 × Draws) / Total Games
- **Popularity** = Games Played / Total Games in Position

## Branch Termination

Branches terminate when:
1. **Max depth reached**: Specified depth limit hit
2. **Insufficient games**: Position has fewer than `min-games` games
3. **White advantage**: No Black response scores above `advantage-threshold`
4. **Low popularity**: No moves meet the popularity threshold

## Output Format

### PGN Format
```
[Event "Nf3 Repertoire"]
[Site "Generated by Chess Repertoire Generator"]
[Date "????.??.??"]
[Round "?"]
[White "?"]
[Black "?"]
[Result "*"]

1. Nf3 d5 2. d4 (1...Nc6 2. d4) (1...Nf6 2. d4) *
```

## Cache System

The system maintains a persistent JSON cache of Lichess API responses to:
- Avoid redundant API calls
- Speed up subsequent runs
- Respect API rate limits

Cache keys are generated from position FEN, rating filter, and time controls.

## Examples

### Generate Classical Repertoire
```bash
uv run python repertoire_builder.py \
  --opening "d4" \
  --time-controls "classical" \
  --min-rating 2200 \
  --depth 8 \
  --output-pgn output/d4_classical.pgn
```

### Quick Analysis
```bash
uv run python repertoire_builder.py \
  --opening "e4" \
  --depth 3 \
  --min-games 100 \
  --output-pgn output/e4_quick.pgn
```

## Requirements

- Python 3.10+
- uv (for dependency management)
- Dependencies: requests, python-chess, click (installed via `uv sync`)